{% extends "base.html" %}

{% block title %}Gross Profit Report | Conserv{% endblock %}

{% block content %}
<section class="card" style="padding:16px;">
  <header style="display:flex; justify-content:space-between; gap:12px; align-items:end;">
    <h2>Gross Profit Report</h2>
    <form method="get" action="">
      <label>From <input type="date" name="from" value="{{ from_date or '' }}"/></label>
      <label>To <input type="date" name="to" value="{{ to_date or '' }}"/></label>
      <button class="btn" type="submit">Filter</button>
      <a class="btn" href="?format=csv{% if from_date %}&from={{ from_date }}{% endif %}{% if to_date %}&to={{ to_date }}{% endif %}">Export CSV</a>
    </form>
  </header>

  <div class="table-wrap" style="margin-top:12px;">
    <table class="report-table" id="tbl-gp">
      <thead>
        <tr>
          <th data-type="text">Type</th><th data-type="text">Name</th><th class="numeric" data-type="number">Qty (yd³)</th><th class="numeric" data-type="number">Revenue</th>
          <th class="numeric" data-type="number">Avg Cost/yd³</th><th class="numeric" data-type="number">COGS</th><th class="numeric" data-type="number">GP</th><th class="numeric" data-type="number">Margin %</th>
        </tr>
      </thead>
      <tbody>
      {% if not rows and not by_customer %}
        <tr><td colspan="8" style="text-align:center;">No data for selection.</td></tr>
      {% endif %}

      {# Product rows #}
      {% for r in rows %}
        <tr>
          <td>Product</td>
          <td>{{ r.product }}</td>
          <td>{{ '%.3f' % r.qty_yd3 }}</td>
          <td>${{ '%.2f' % r.revenue }}</td>
          <td>${{ '%.2f' % r.avg_cost_yd3 }}</td>
          <td>${{ '%.2f' % r.cogs }}</td>
          <td>${{ '%.2f' % r.gp }}</td>
          <td>{{ '%.1f' % r.margin }}</td>
        </tr>
      {% endfor %}

      {# Customer rows #}
      {% for r in by_customer %}
        <tr>
          <td>Customer</td>
          <td>{{ r.customer }}</td>
          <td>{{ '%.3f' % r.qty_yd3 }}</td>
          <td>${{ '%.2f' % r.revenue }}</td>
          <td></td>
          <td>${{ '%.2f' % r.cogs }}</td>
          <td>${{ '%.2f' % r.gp }}</td>
          <td>{{ '%.1f' % r.margin }}</td>
        </tr>
      {% endfor %}

        {% if grand %}
          <tr class="row-total">
            <td><strong>TOTAL</strong></td>
            <td></td>
            <td class="numeric"><strong>{{ '%.3f' % grand.qty_yd3 }}</strong></td>
            <td class="numeric"><strong>${{ '%.2f' % grand.revenue }}</strong></td>
            <td></td>
            <td class="numeric"><strong>${{ '%.2f' % grand.cogs }}</strong></td>
            <td class="numeric"><strong>${{ '%.2f' % grand.gp }}</strong></td>
            <td class="numeric"><strong>{{ '%.1f' % grand.margin }}</strong></td>
          </tr>
          <tr class="row-total">
            <td><strong>OPEX</strong></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td class="numeric"><strong>${{ '%.2f' % (opex_total or 0) }}</strong></td>
            <td></td>
            <td></td>
          </tr>
          <tr class="row-total">
            <td><strong>NET PROFIT</strong></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td class="numeric"><strong>${{ '%.2f' % (net_profit or 0) }}</strong></td>
            <td></td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <script>
    (function(){
      function sortTable(tblId, th){
        const tbody = document.querySelector('#'+tblId+' tbody'); if(!tbody) return;
        const type = th.getAttribute('data-type')||'text';
        const idx = Array.from(th.parentNode.children).indexOf(th);
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const dir = th.getAttribute('data-dir')==='asc' ? 'desc' : 'asc';
        rows.sort((a,b)=>{
          const A = a.children[idx].innerText.replace(/[$,%]/g,'');
          const B = b.children[idx].innerText.replace(/[$,%]/g,'');
          if(type==='number') return (parseFloat(A)||0)-(parseFloat(B)||0);
          return A.localeCompare(B);
        });
        if(dir==='desc') rows.reverse();
        tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r));
        th.setAttribute('data-dir', dir);
      }
      document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('#tbl-gp thead th').forEach(th=>{
          th.addEventListener('click', ()=>sortTable('tbl-gp', th));
        });
      });
    })();
  </script>
</section>
{% endblock %}


